databases:
  - name: terapixel-platform-db
    databaseName: terapixel_platform
    user: terapixel_platform
    plan: basic-256mb

services:
  - type: web
    name: terapixel-identity-gateway
    env: node
    plan: starter
    buildCommand: npm ci
    startCommand: npm run start:identity
    healthCheckPath: /healthz
    envVars:
      - key: SESSION_SIGNING_ALG
        value: "RS256"
      - key: SESSION_SIGNING_KEY_ID
        value: "tpx-session-v1"
      - key: SESSION_SIGNING_KEY_PEM
        sync: false
      - key: SESSION_SECRET
        sync: false
      - key: SESSION_LEGACY_CUTOFF_UTC
        value: "2026-05-31T00:00:00Z"
      - key: IDENTITY_ADMIN_KEY
        sync: false
      - key: INTERNAL_SERVICE_KEY
        sync: false
      - key: CRAZYGAMES_EXPECTED_AUDIENCE
        sync: false
      - key: CRAZYGAMES_EXPECTED_ISSUER
        value: "https://sdk.crazygames.com/authentication/"
      - key: CRAZYGAMES_JWKS_URL
        value: "https://sdk.crazygames.com/authentication/keys.json"
      - key: SESSION_ISSUER
        value: "terapixel.identity"
      - key: SESSION_AUDIENCE
        value: "terapixel.game"
      - key: SESSION_TTL_SECONDS
        value: "3600"
      - key: SESSION_JWKS_PATH
        value: "/.well-known/jwks.json"
      - key: CLOCK_SKEW_SECONDS
        value: "10"
      - key: CORS_ALLOWED_ORIGINS
        sync: false
      - key: IDENTITY_STORE_TYPE
        value: "postgres"
      - key: DATABASE_URL
        fromDatabase:
          name: terapixel-platform-db
          property: connectionString
      - key: PLATFORM_CONFIG_STORE_TYPE
        value: "postgres"
      - key: PLATFORM_CONFIG_ENVIRONMENT
        value: "prod"
      - key: PLATFORM_CONFIG_CACHE_TTL_SECONDS
        value: "15"
      - key: PLATFORM_CONFIG_ENCRYPTION_KEY
        sync: false
      - key: IAP_INTERNAL_MERGE_URL
        sync: false
      - key: SAVE_INTERNAL_MERGE_URL
        sync: false
      - key: FLAGS_INTERNAL_MERGE_URL
        sync: false
      - key: TELEMETRY_INTERNAL_MERGE_URL
        sync: false
      - key: MAGIC_LINK_FROM_EMAIL
        value: "no-reply@terapixel.games"
      - key: MAGIC_LINK_REPLY_TO_EMAIL
        value: "support@terapixel.games"
      - key: MAGIC_LINK_SUBJECT
        value: "Terapixel Games Magic Link"
      - key: MAGIC_LINK_BASE_URL
        value: "https://terapixel.games/api/v1/account/magic-link/consume"
      - key: MAGIC_LINK_MOBILE_BASE_URL
        sync: false
      - key: MAGIC_LINK_SIGNING_SECRET
        sync: false
      - key: MAGIC_LINK_TTL_SECONDS
        value: "900"
      - key: MAGIC_LINK_RATE_LIMIT_PER_HOUR
        value: "5"
      - key: USERNAME_BLOCKLIST_GLOBAL
        sync: false
      - key: USERNAME_BLOCKLIST_BY_GAME_JSON
        sync: false
      - key: MAGIC_LINK_DEFAULT_GAME_ID
        sync: false
      - key: MAGIC_LINK_NAKAMA_NOTIFY_TARGETS_JSON
        sync: false
      - key: MAGIC_LINK_NAKAMA_NOTIFY_URL
        sync: false
      - key: MAGIC_LINK_NAKAMA_NOTIFY_HTTP_KEY
        sync: false
      - key: MAGIC_LINK_NAKAMA_NOTIFY_SECRET
        sync: false
      - key: SMTP_HOST
        value: "smtp-relay.gmail.com"
      - key: SMTP_PORT
        value: "587"
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASS
        sync: false
      - key: SMTP_SECURE
        value: "false"
      - key: SMTP_REQUIRE_TLS
        value: "true"

  - type: web
    name: terapixel-save-service
    env: node
    plan: starter
    buildCommand: npm ci
    startCommand: npm run start:save
    healthCheckPath: /healthz
    envVars:
      - key: SESSION_JWKS_URL
        value: "https://terapixel-identity-gateway.onrender.com/.well-known/jwks.json"
      - key: SESSION_LEGACY_CUTOFF_UTC
        value: "2026-05-31T00:00:00Z"
      - key: INTERNAL_SERVICE_KEY
        sync: false
      - key: SESSION_ISSUER
        value: "terapixel.identity"
      - key: SESSION_AUDIENCE
        value: "terapixel.game"
      - key: CLOCK_SKEW_SECONDS
        value: "10"
      - key: CORS_ALLOWED_ORIGINS
        sync: false
      - key: SAVE_STORE_TYPE
        value: "postgres"
      - key: DATABASE_URL
        fromDatabase:
          name: terapixel-platform-db
          property: connectionString
      - key: SAVE_STORE_TABLE
        value: "save_envelopes"
      - key: PLATFORM_CONFIG_STORE_TYPE
        value: "postgres"
      - key: PLATFORM_CONFIG_ENVIRONMENT
        value: "prod"
      - key: PLATFORM_CONFIG_CACHE_TTL_SECONDS
        value: "15"

  - type: web
    name: terapixel-feature-flags
    env: node
    plan: starter
    buildCommand: npm ci
    startCommand: npm run start:flags
    healthCheckPath: /healthz
    envVars:
      - key: SESSION_JWKS_URL
        value: "https://terapixel-identity-gateway.onrender.com/.well-known/jwks.json"
      - key: SESSION_LEGACY_CUTOFF_UTC
        value: "2026-05-31T00:00:00Z"
      - key: INTERNAL_SERVICE_KEY
        sync: false
      - key: SESSION_ISSUER
        value: "terapixel.identity"
      - key: SESSION_AUDIENCE
        value: "terapixel.game"
      - key: CLOCK_SKEW_SECONDS
        value: "10"
      - key: CORS_ALLOWED_ORIGINS
        sync: false
      - key: FEATURE_FLAGS_ADMIN_KEY
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: terapixel-platform-db
          property: connectionString
      - key: FLAG_STORE_TYPE
        value: "memory"
      - key: FLAG_STORE_FILE_PATH
        value: "./data/feature-flags.json"
      - key: FEATURE_FLAGS_BOOTSTRAP_JSON
        sync: false
      - key: PLATFORM_CONFIG_STORE_TYPE
        value: "postgres"
      - key: PLATFORM_CONFIG_ENVIRONMENT
        value: "prod"
      - key: PLATFORM_CONFIG_CACHE_TTL_SECONDS
        value: "15"

  - type: web
    name: terapixel-telemetry-ingest
    env: node
    plan: starter
    buildCommand: npm ci
    startCommand: npm run start:telemetry
    healthCheckPath: /healthz
    envVars:
      - key: SESSION_JWKS_URL
        value: "https://terapixel-identity-gateway.onrender.com/.well-known/jwks.json"
      - key: SESSION_LEGACY_CUTOFF_UTC
        value: "2026-05-31T00:00:00Z"
      - key: INTERNAL_SERVICE_KEY
        sync: false
      - key: SESSION_ISSUER
        value: "terapixel.identity"
      - key: SESSION_AUDIENCE
        value: "terapixel.game"
      - key: CLOCK_SKEW_SECONDS
        value: "10"
      - key: CORS_ALLOWED_ORIGINS
        sync: false
      - key: TELEMETRY_REQUIRE_SESSION
        value: "true"
      - key: TELEMETRY_MAX_EVENTS_PER_REQUEST
        value: "100"
      - key: TELEMETRY_STORE_TYPE
        value: "memory"
      - key: TELEMETRY_FILE_PATH
        value: "./data/telemetry-events.jsonl"
      - key: DATABASE_URL
        fromDatabase:
          name: terapixel-platform-db
          property: connectionString
      - key: PLATFORM_CONFIG_STORE_TYPE
        value: "postgres"
      - key: PLATFORM_CONFIG_ENVIRONMENT
        value: "prod"
      - key: PLATFORM_CONFIG_CACHE_TTL_SECONDS
        value: "15"

  - type: web
    name: terapixel-iap-service
    env: node
    plan: starter
    buildCommand: npm ci
    startCommand: npm run start:iap
    healthCheckPath: /healthz
    envVars:
      - key: SESSION_JWKS_URL
        value: "https://terapixel-identity-gateway.onrender.com/.well-known/jwks.json"
      - key: SESSION_LEGACY_CUTOFF_UTC
        value: "2026-05-31T00:00:00Z"
      - key: INTERNAL_SERVICE_KEY
        sync: false
      - key: SESSION_ISSUER
        value: "terapixel.identity"
      - key: SESSION_AUDIENCE
        value: "terapixel.game"
      - key: CLOCK_SKEW_SECONDS
        value: "10"
      - key: CORS_ALLOWED_ORIGINS
        sync: false
      - key: IAP_ADMIN_KEY
        sync: false
      - key: IAP_STORE_TYPE
        value: "postgres"
      - key: DATABASE_URL
        fromDatabase:
          name: terapixel-platform-db
          property: connectionString
      - key: PLATFORM_CONFIG_STORE_TYPE
        value: "postgres"
      - key: PLATFORM_CONFIG_ENVIRONMENT
        value: "prod"
      - key: PLATFORM_CONFIG_CACHE_TTL_SECONDS
        value: "15"
      - key: PLATFORM_CONFIG_ENCRYPTION_KEY
        sync: false

  - type: web
    name: terapixel-control-plane
    env: node
    plan: starter
    buildCommand: npm ci
    startCommand: npm run start:control-plane
    healthCheckPath: /healthz
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: terapixel-platform-db
          property: connectionString
      - key: GOOGLE_OAUTH_CLIENT_ID
        sync: false
      - key: GOOGLE_WORKSPACE_DOMAINS
        sync: false
      - key: CONTROL_PLANE_BOOTSTRAP_EMAILS
        sync: false
      - key: INTERNAL_SERVICE_KEY
        sync: false
      - key: PLATFORM_CONFIG_ENCRYPTION_KEY
        sync: false
      - key: CORS_ALLOWED_ORIGINS
        sync: false
