name: Cloud Run Deploy

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      target:
        description: "Deploy target"
        required: true
        type: choice
        default: staging
        options:
          - staging
          - prod

permissions:
  contents: read
  id-token: write

concurrency:
  group: cloudrun-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && (inputs.target == 'prod' && 'production' || 'staging') || (startsWith(github.ref, 'refs/tags/v') && 'production' || 'staging') }}
    env:
      TARGET: ${{ github.event_name == 'workflow_dispatch' && inputs.target || (startsWith(github.ref, 'refs/tags/v') && 'prod' || 'staging') }}
      GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      GCP_REGION: ${{ vars.GCP_REGION != '' && vars.GCP_REGION || 'us-central1' }}
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT: ${{ vars.GCP_SERVICE_ACCOUNT }}
      CLOUDRUN_SERVICE: ${{ vars.CLOUDRUN_SERVICE != '' && vars.CLOUDRUN_SERVICE || 'terapixel-identity-gateway' }}
      CLOUDRUN_IMAGE_BASE: ${{ vars.CLOUDRUN_IMAGE_BASE }}
      CLOUDRUN_ALLOW_UNAUTHENTICATED: ${{ vars.CLOUDRUN_ALLOW_UNAUTHENTICATED != '' && vars.CLOUDRUN_ALLOW_UNAUTHENTICATED || 'true' }}
      CLOUDRUN_DEPLOY_FLAGS_JSON: ${{ vars.CLOUDRUN_DEPLOY_FLAGS_JSON }}
      CLOUDRUN_ENV_VARS_JSON: ${{ secrets.CLOUDRUN_ENV_VARS_JSON }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required configuration
        shell: bash
        run: |
          set -euo pipefail
          for key in GCP_PROJECT_ID GCP_WORKLOAD_IDENTITY_PROVIDER GCP_SERVICE_ACCOUNT CLOUDRUN_SERVICE CLOUDRUN_IMAGE_BASE; do
            if [ -z "${!key:-}" ]; then
              echo "Missing required variable: $key"
              exit 1
            fi
          done

      - name: Authenticate to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Build image and deploy to Cloud Run
        id: deploy
        shell: bash
        run: |
          set -euo pipefail

          image_tag="${GITHUB_SHA::12}"
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            image_tag="${GITHUB_REF_NAME}"
          fi

          image="${CLOUDRUN_IMAGE_BASE}:${image_tag}"
          echo "image=${image}" >> "$GITHUB_OUTPUT"

          gcloud builds submit . \
            --project "${GCP_PROJECT_ID}" \
            --tag "${image}" \
            --file services/identity-gateway/Dockerfile \
            --quiet

          deploy_args=(
            "${CLOUDRUN_SERVICE}"
            "--project=${GCP_PROJECT_ID}"
            "--region=${GCP_REGION}"
            "--platform=managed"
            "--image=${image}"
            "--quiet"
          )

          auth_mode="$(echo "${CLOUDRUN_ALLOW_UNAUTHENTICATED}" | tr '[:upper:]' '[:lower:]')"
          if [[ "${auth_mode}" == "true" || "${auth_mode}" == "1" || "${auth_mode}" == "yes" ]]; then
            deploy_args+=("--allow-unauthenticated")
          else
            deploy_args+=("--no-allow-unauthenticated")
          fi

          if [ -n "${CLOUDRUN_ENV_VARS_JSON:-}" ]; then
            env_file="${RUNNER_TEMP}/cloudrun-env.json"
            printf '%s' "${CLOUDRUN_ENV_VARS_JSON}" > "${env_file}"
            jq -e 'type == "object"' "${env_file}" >/dev/null
            deploy_args+=("--env-vars-file=${env_file}")
          fi

          if [ -n "${CLOUDRUN_DEPLOY_FLAGS_JSON:-}" ]; then
            mapfile -t extra_flags < <(printf '%s' "${CLOUDRUN_DEPLOY_FLAGS_JSON}" | jq -er '.[]')
            if [ "${#extra_flags[@]}" -gt 0 ]; then
              deploy_args+=("${extra_flags[@]}")
            fi
          fi

          gcloud run deploy "${deploy_args[@]}"

          service_url="$(gcloud run services describe "${CLOUDRUN_SERVICE}" \
            --project "${GCP_PROJECT_ID}" \
            --region "${GCP_REGION}" \
            --format='value(status.url)')"
          echo "service_url=${service_url}" >> "$GITHUB_OUTPUT"

      - name: Deployment summary
        shell: bash
        run: |
          cat <<EOF >> "$GITHUB_STEP_SUMMARY"
          ## Cloud Run Deploy
          - Target: \`${TARGET}\`
          - Service: \`${CLOUDRUN_SERVICE}\`
          - Region: \`${GCP_REGION}\`
          - Image: \`${{ steps.deploy.outputs.image }}\`
          - URL: ${{ steps.deploy.outputs.service_url }}
          EOF
